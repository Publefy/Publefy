# Publefy Backend

## Technologies
- Python 3.13
- Flask
- MongoDB
- Google Cloud (Vertex AI)
- Docker
- APScheduler

## Database Structure (MongoDB)

### Collections and their purposes:

1. **users** - Stores user information
   - `_id`: Unique user identifier in ObjectId format
   - `name`: User's display name
   - `email`: User's email, used as login
   - `password`: Hashed user password (using bcrypt)

2. **profiles** - Contains social media profiles linked to users
   - `_id`: Unique profile identifier
   - `ig_id`: Instagram account ID
   - `name`: Profile name (e.g., "My Business Account")
   - `platform`: Social network platform (e.g., "instagram")
   - `image`: Profile avatar URL
   - `access_token`: Social network API access token for request authorization

3. **reels** - Stores information about processed videos and generated memes
   - `reel_id`: Unique video identifier
   - `user_id`: ID of the user who uploaded the video
   - `summary`: Brief description of video content, generated by AI
   - `status`: Current processing status (e.g., "processing", "completed", "error")
   - `text_coordinates`: Coordinates for text placement in video (x, y, width, height)
   - `text_color`: RGB text color, chosen for optimal readability
   - `background_color`: Dominant video background color
   - `funny_meme_options`: List of AI-generated meme text options
   - `video_path`: Path to processed video with overlaid text
   - `original_video_path`: Path to original uploaded video
   - `error`: Error message if something went wrong

4. **posts** - Manages scheduled social media publications
   - `_id`: Unique publication identifier
   - `hashtags`: List of hashtags for publication
   - `reel_id`: ID of processed video to be published
   - `caption`: Publication description text
   - `scheduled_time`: Scheduled publication time in datetime format
   - `scheduled_unix`: Unix timestamp of scheduled time (for quick sorting)
   - `created_time`: Publication record creation time
   - `profile_id`: ID of profile where content will be published
   - `color`: Publication color scheme
   - `status`: Publication status ("scheduled", "published", "failed")
   - `media_id`: Social network media ID after publication

5. **platforms** - Contains information about supported social platforms
   - `_id`: Unique platform identifier
   - `name`: Platform name (e.g., "Instagram", "TikTok")
   - `image`: Platform icon URL

## Installation and Setup

### Prerequisites
1. Python 3.13
2. MongoDB
3. Tesseract OCR
4. Google Cloud SDK
5. Docker (optional)

### Local Installation

1. **Create and activate virtual environment**
   ```bash
   python -m venv .venv
   .venv\Scripts\activate  # Windows
   source .venv/bin/activate  # Linux/Mac
   ```

2. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```

3. **Configure environment variables**
   Create a `.env` file with the following variables:
   ```
   MONGO_URI=your_mongodb_connection_string
   SECRET_KEY=your_jwt_secret_key
   FB_APP_ID=your_facebook_app_id
   FB_APP_SECRET=your_facebook_app_secret
   REDIRECT_URI=your_redirect_uri
   TESSERACT_CMD=path_to_tesseract_executable
   ```

4. **Google Cloud Setup**
   ```bash
   gcloud auth login
   gcloud config set project publefy
   gcloud services enable aiplatform.googleapis.com
   gcloud auth application-default login
   ```

5. **Start server**
   ```bash
   # Option A (direct): run Uvicorn against ASGI-wrapped Flask app
   uvicorn main:asgi --reload

   # Option B (recommended): run consolidated ASGI app (FastAPI mounts Flask)
   python run_uvicorn.py
   ```

### Docker (Local Dev)

1. **Build and run with docker-compose**
   ```bash
   docker-compose up --build
   ```

## Container Image: Build, Tag, and Push to Docker Hub

Use these commands to build the image, find the latest image ID, tag it, and push it to Docker Hub. Replace placeholders with your actual values.

1. **Build the image**
   ```bash
   docker build -t publefy:latest .
   ```

2. **List images and copy the latest IMAGE ID**
   ```bash
   docker image list
   ```

3. **Tag the image with your Docker Hub repo**
   - Replace `IMAGE_ID` and `YOUR_DOCKERHUB_USERNAME`.
   ```bash
   docker image tag IMAGE_ID YOUR_DOCKERHUB_USERNAME/publefy:latest
   # Example (from your prompt):
   # docker image tag d60fb0e735b1 danilrev/publefy7
   ```

4. **Login to Docker Hub (if not already)**
   ```bash
   docker login
   ```

5. **Push the image to Docker Hub**
   ```bash
   docker image push YOUR_DOCKERHUB_USERNAME/publefy:latest
   # Or, if you used a numeric/tagged name as in the example:
   # docker image push danilrev/publefy7
   ```

## Deploy to Google Cloud Run (Console UI)

Prerequisites:
- A Google Cloud project with Cloud Run enabled
- Proper permissions to deploy to Cloud Run
- Docker image pushed to Docker Hub (e.g., `docker.io/YOUR_DOCKERHUB_USERNAME/publefy:latest`)

Steps:
1. Open Google Cloud Console â†’ Cloud Run.
2. Find the service named `publefy` and click it.
3. Click "Edit & deploy new revision".
4. In "Container image URL", paste your Docker Hub image, e.g.
   - `docker.io/YOUR_DOCKERHUB_USERNAME/publefy:latest`
5. (Optional but recommended) Configure:
   - Environment variables (match those from the ".env" section as needed)
   - CPU/Memory, Concurrency, Min/Max instances
   - Port: 8080 (default for Cloud Run; ensure your app listens on `$PORT`)
6. Click Deploy and wait for the new revision to become Ready.

### Optional: Deploy via gcloud CLI

If you prefer CLI instead of the console:
```bash
gcloud run deploy publefy \
  --image=docker.io/YOUR_DOCKERHUB_USERNAME/publefy:latest \
  --platform=managed \
  --region=YOUR_REGION \
  --allow-unauthenticated
```
Replace `YOUR_REGION` (e.g., `us-central1`) and provide env vars via `--set-env-vars` as needed.

## API Endpoints

### Authentication
- `POST /auth/register` - Register new user
- `POST /auth/login` - Login to system

### Profiles
- `POST /profiles/create` - Create new profile
- `GET /profiles` - Get list of profiles

### Video
- `POST /video/process` - Process video
- `GET /video/analyze` - Analyze video
- `POST /video/finalize` - Finalize video processing

### Instagram
- `POST /instagram/schedule` - Schedule publication
- `GET /instagram/auth` - Instagram authentication

### Infrastructure
- `GET /infrastructure/platforms` - Get list of platforms
- `POST /infrastructure/platforms/create` - Create new platform

## Features and Nuances

1. **Video Processing**
   - System uses Tesseract OCR for text recognition in videos
   - Requires installation of additional system dependencies for video processing

2. **Google Cloud Integration**
   - Project setup in Google Cloud Console required
   - Appropriate permissions needed for Vertex AI  

3. **Instagram API**
   - Facebook App creation and token acquisition required
   - Proper permissions must be configured in Facebook Developer Console

4. **Task Scheduler**
   - Uses APScheduler for managing delayed publications
   - All scheduled tasks are reloaded from database on server restart

5. **Security**
   - All passwords are hashed using bcrypt
   - JWT tokens used for authentication
   - CORS configured only for allowed domains

## Monitoring and Logging

- System logs main operations to console
- `/health` endpoint available for service health check

