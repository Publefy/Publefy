name: Deploy Dev & Prod

on:
  push:
    branches: [ "dev", "main" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/publefy

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine target env
        id: which
        run: |
          if [[ "${GITHUB_REF##*/}" == "dev" ]]; then
            echo "ENVIRON=dev" >> $GITHUB_OUTPUT
            echo "TAG_PREFIX=dev" >> $GITHUB_OUTPUT
          else
            echo "ENVIRON=prod" >> $GITHUB_OUTPUT
            echo "TAG_PREFIX=prod" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.which.outputs.TAG_PREFIX }}-${{ github.sha }}
            type=raw,value=${{ steps.which.outputs.TAG_PREFIX }}-latest

      - name: Build & push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      # --- Ship config files to VM ---
      - name: Copy Nginx config
        uses: appleboy/scp-action@v0.1.7
        with:
          host:  ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key:  ${{ secrets.VM_SSH_KEY }}
          source: "ops/nginx/site.conf"
          target: "/tmp/site.conf"

      - name: Copy compose files
        uses: appleboy/scp-action@v0.1.7
        with:
          host:  ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key:  ${{ secrets.VM_SSH_KEY }}
          source: "docker-compose.*.yml"
          target: "/tmp/"

      - name: Copy refresh script
        uses: appleboy/scp-action@v0.1.7
        with:
          host:  ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key:  ${{ secrets.VM_SSH_KEY }}
          source: "ops/scripts/refresh.sh"
          target: "/tmp/refresh.sh"

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          GHCR_USER: ${{ github.actor }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_SHA: ${{ github.sha }}
          ENVIRON: ${{ steps.which.outputs.ENVIRON }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            # Place compose files
            sudo mkdir -p /opt/publefy-dev/compose /opt/publefy-prod/compose /opt/publefy-tools
            sudo mv /tmp/docker-compose.dev.yml  /opt/publefy-dev/compose/docker-compose.dev.yml
            sudo mv /tmp/docker-compose.prod.yml /opt/publefy-prod/compose/docker-compose.prod.yml

            # Install Nginx config once for both envs
            sudo mv /tmp/site.conf /etc/nginx/sites-available/publefy.conf
            sudo ln -sf /etc/nginx/sites-available/publefy.conf /etc/nginx/sites-enabled/publefy.conf
            sudo nginx -t
            sudo systemctl reload nginx

            # Install refresh script
            sudo mv /tmp/refresh.sh /opt/publefy-tools/refresh.sh
            sudo chmod +x /opt/publefy-tools/refresh.sh

            # Ensure env files exist (you fill them on the VM)
            sudo touch /opt/publefy-dev/.env.dev
            sudo touch /opt/publefy-prod/.env

            # Run deploy for the selected environment
            export GHCR_USER="${GHCR_USER}"
            export GHCR_TOKEN="${GHCR_TOKEN}"
            export GIT_SHA="${GIT_SHA}"

            /opt/publefy-tools/refresh.sh "${ENVIRON}"

            # Optional: remove dangling images
            docker image prune -f
